<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
  body {
    background-color: #000;
    color: #fff;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    margin: 0;
    padding: 0;
    min-height: 100vh;
  }
  .nav-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid #333;
    background-color: #000;
    position: sticky;
    top: 0;
    z-index: 100;
  }
  .nav-btn {
    background: none;
    border: none;
    color: #999;
    cursor: pointer;
    font-size: 14px;
    text-decoration: none;
  }
  .nav-btn:hover {
    color: #fff;
  }
  .clear-btn {
    background-color: #ff0000;
    color: #fff;
    padding: 10px 20px;
    border-radius: 8px;
    border: none;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
  }
  .clear-btn:hover {
    background-color: #cc0000;
  }
  .stylist-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
  }
  .chat-header {
    text-align: center;
    padding: 40px 20px;
    background: linear-gradient(135deg, #8e2de2 0%, #4a00e0 100%);
    border-radius: 16px;
    margin-bottom: 30px;
    box-shadow: 0 0 20px rgba(142, 45, 226, 0.4);
  }
  .chat-header h1 {
    font-size: 42px;
    font-weight: 700;
    margin-bottom: 12px;
    background: linear-gradient(90deg, #fff 0%, #cfc7ff 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  .chat-header p {
    font-size: 16px;
    color: #d1c4ff;
    font-style: italic;
  }
  .chat-messages {
    background-color: #1a1a1a;
    border-radius: 12px;
    padding: 20px;
    min-height: 400px;
    max-height: 500px;
    overflow-y: auto;
    margin-bottom: 20px;
  }
  .message { margin-bottom: 20px; display: flex; gap: 12px; }
  .message.user { flex-direction: row-reverse; }
  .message-avatar {
    width: 40px; height: 40px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center; font-weight: 700;
  }
  .message.user .message-avatar {
    background: linear-gradient(135deg, #00bfff 0%, #007acc 100%);
  }
  .message.assistant .message-avatar {
    background: linear-gradient(135deg, #8e2de2 0%, #4a00e0 100%);
  }
  .message-content {
    background-color: #222;
    padding: 15px;
    border-radius: 12px;
    max-width: 70%;
  }
  .message.user .message-content {
    background: linear-gradient(135deg, #00bfff 0%, #007acc 100%);
    color: #000;
  }
  .chat-input-container {
    background-color: #1a1a1a;
    border-radius: 12px;
    padding: 20px;
    display: flex;
    gap: 15px;
  }
  .chat-input {
    flex: 1;
    padding: 15px;
    background-color: #222;
    border: 1px solid #333;
    border-radius: 8px;
    color: #fff;
    font-size: 16px;
  }
  .send-btn {
    padding: 15px 30px;
    background: linear-gradient(135deg, #8e2de2 0%, #4a00e0 100%);
    color: #fff;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
  }
  .send-btn:hover { transform: scale(1.05); }
  .loading { display: none; text-align: center; color: #8e2de2; padding: 20px; }
  .loading.active { display: block; }
</style>

<div class="nav-bar">
  <%= link_to root_path, class: "nav-btn" do %>
    <i class="fa-solid fa-arrow-left"></i> Back to Feed
  <% end %>

  <%= link_to stylist_clear_path,
    method: :delete,
    data: { confirm: "Clear chat history?" },
    class: "clear-btn" do %>
  <i class="fa-solid fa-trash"></i> Clear Chat
  <% end %>
</div>

<div class="stylist-container">
  <div class="chat-header">
    <h1>Ask Milo</h1>
    <p>Color Theorist • Stylist • Instagram Manager</p>
  </div>

  <div class="chat-messages" id="chatMessages">
    <% if @messages.any? %>
      <% @messages.each do |message| %>
        <div class="message <%= message[:role] %>">
          <div class="message-avatar">
            <% if message[:role] == 'user' %>
              <%= current_user.initials %>
            <% else %>
              <i class="fa-solid fa-scissors"></i>
            <% end %>
          </div>
          <div class="message-content">
            <%= simple_format(message[:content]) %>
          </div>
        </div>
      <% end %>
    <% else %>
      <div class="empty-state">
        <i class="fa-solid fa-sparkles"></i>
        <h3>Meet Milo</h3>
        <p>Your virtual stylist and instagram technician, with the mind of a photographer.</p>
      </div>
    <% end %>

    <div class="loading" id="loadingIndicator">
      <i class="fa-solid fa-spinner fa-spin"></i> Milo is thinking...
    </div>
  </div>

  <div class="chat-input-container">
    <textarea id="messageInput" class="chat-input" placeholder="Ask Milo your style question..." rows="3"></textarea>
    <button id="sendBtn" class="send-btn" onclick="sendMessage()">
      <i class="fa-solid fa-paper-plane"></i> Send
    </button>
  </div>
</div>

<script>
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const chatMessages = document.getElementById('chatMessages');
  const loadingIndicator = document.getElementById('loadingIndicator');

  
  messageInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  async function sendMessage() {
    const message = messageInput.value.trim();
    if (!message) return;

    sendBtn.disabled = true;
    messageInput.disabled = true;
    loadingIndicator.classList.add('active');

    try {
      const response = await fetch("<%= stylist_chat_path %>", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({ message: message })
      });

      const data = await response.json();

      chatMessages.innerHTML = "";
      data.messages.forEach(msg => {
        const div = document.createElement("div");
        div.classList.add("message", msg.role);
        div.innerHTML = `
          <div class="message-avatar">
            ${msg.role === 'user'
              ? "<%= current_user.initials %>"
              : '<i class="fa-solid fa-scissors"></i>'}
          </div>
          <div class="message-content">${msg.content}</div>
        `;
        chatMessages.appendChild(div);
      });

      chatMessages.scrollTop = chatMessages.scrollHeight;
    } catch (err) {
      console.error("Chat error:", err);
      alert("Milo’s off his game! Try again.");
    } finally {
      messageInput.value = "";
      messageInput.disabled = false;
      sendBtn.disabled = false;
      loadingIndicator.classList.remove('active');
    }
  }
</script>
